<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZMK Configurator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            background: #f4f4f5;
            color: #18181b;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        h1 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #27272a;
        }

        h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e4e4e7;
            padding-bottom: 0.5rem;
        }

        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            background: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn-green {
            background: #059669;
        }

        .btn-green:hover {
            background: #047857;
        }

        .btn-purple {
            background: #7c3aed;
        }

        .btn-purple:hover {
            background: #6d28d9;
        }

        input[type="file"] {
            margin-bottom: 1rem;
        }

        .flash-messages {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            background: #dbeafe;
            color: #1e40af;
        }

        .row {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        #build-log-container {
            background: #1e1e1e;
            color: #e5e5e5;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
            white-space: pre-wrap;
            font-size: 0.85rem;
        }

        #timer {
            float: right;
            font-weight: bold;
            color: #7c3aed;
        }

        .hidden {
            display: none !important;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>ZMK Corne Configurator</h1>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="flash-messages">
            {% for message in messages %}
            <div>{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <h2>1. Import Layout</h2>
        <p>Choose an existing template or upload a new <code>.vil</code> file.</p>
        <form action="/upload" method="post" enctype="multipart/form-data">
            <div style="margin-bottom: 1rem;">
                <label>Select Existing Template:</label>
                <select name="existing_file" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                    <option value="">-- Choose a file --</option>
                    {% for t in templates %}
                    <option value="{{ t }}">{{ t }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="text-align: center; margin: 1rem 0; font-weight: bold; color: #71717a;">- OR -</div>

            <div style="margin-bottom: 1rem;">
                <label>Upload New:</label>
                <input type="file" name="vil_file" accept=".vil" style="display: block; margin-top: 0.5rem;">
            </div>

            <button type="submit" class="btn">Convert to Keymap</button>
        </form>

        {% if conversion_stats %}
        <div
            style="margin-top: 1.5rem; background: #fafafa; border: 1px solid #e4e4e7; border-radius: 8px; padding: 1rem;">
            <h3 style="margin-top: 0; font-size: 1.1rem; color: #27272a;">Conversion Report</h3>
            <pre style="margin: 0; color: #52525b; font-size: 0.9rem;">{{ conversion_stats }}</pre>

            {% if layer_images %}
            <div style="margin-top: 1rem;">
                <h4 style="margin: 0.5rem 0; color: #3f3f46;">Generated Layout Previews</h4>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for img in layer_images %}
                    <div style="border: 1px solid #ddd; padding: 0.5rem; background: white; border-radius: 6px;">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ img.replace('.png', '').replace('_',
                            ' ').upper() }}</div>
                        <img src="{{ url_for('static', filename='images/' + img) }}"
                            style="max-width: 100%; height: auto; display: block;" alt="{{ img }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if keymap_content %}
            <details style="margin-top: 1rem;">
                <summary style="cursor: pointer; color: #2563eb; font-weight: 500;">View Generated Keymap File</summary>
                <div id="log-container"
                    style="height: 300px; margin-top: 0.5rem; background: #fff; color: #333; border: 1px solid #ddd;">{{
                    keymap_content }}</div>
            </details>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="card">
        <h2>
            2. Build Firmware
            <span id="timer" class="hidden">00:00</span>
        </h2>
        <p>Push changes to GitHub to trigger a cloud build. This takes ~3 minutes.</p>
        <button id="build-btn" class="btn btn-purple" onclick="triggerBuild()">Push & Trigger Build</button>

        <div id="build-log-container" class="hidden">Waiting for logs...</div>
    </div>

    <script>
        let pollInterval;

        async function triggerBuild() {
            const btn = document.getElementById('build-btn');
            const logBox = document.getElementById('build-log-container');

            btn.disabled = true;
            btn.innerText = "Starting...";
            logBox.classList.remove('hidden');
            logBox.innerText = "Initiating build process and syncing with GitHub...\n";

            try {
                const res = await fetch('/git_push', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    startPolling();
                } else {
                    logBox.innerText += "\nError: " + data.message;
                    btn.disabled = false;
                }
            } catch (e) {
                logBox.innerText += "\nNetwork Error: " + e;
                btn.disabled = false;
            }
        }

        function startPolling() {
            document.getElementById('timer').classList.remove('hidden');
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(fetchLogs, 2000);
            fetchLogs();
        }

        async function fetchLogs() {
            try {
                const res = await fetch('/build_status');
                const data = await res.json();

                const logBox = document.getElementById('build-log-container');
                if (data.logs) {
                    logBox.innerText = data.logs;
                }
                logBox.scrollTop = logBox.scrollHeight;

                if (data.duration > 0) {
                    const mins = Math.floor(data.duration / 60);
                    const secs = data.duration % 60;
                    document.getElementById('timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                }

                if (data.logs && data.logs.includes("Build Complete")) {
                    clearInterval(pollInterval);
                    document.getElementById('timer').innerText += " (Done!)";
                    document.getElementById('build-btn').innerText = "Push & Trigger Build";
                    document.getElementById('build-btn').disabled = false;
                }
            } catch (e) {
                console.error("Poll error", e);
            }
        }
    </script>

    <div class="card">
        <h2>3. Flash Firmware</h2>
        <p>Once downloaded (check folder `firmware_latest`), flash to device.</p>
        <div class="row">
            <button class="btn btn-green" onclick="openFlashModal('left')">Flash Left Side</button>
            <button class="btn btn-green" onclick="openFlashModal('right')">Flash Right Side</button>
        </div>
    </div>

    <!-- Flash Modal -->
    <div id="flash-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2 id="modal-title" style="margin-top:0">Flash Device</h2>
            <div id="modal-step-1">
                <p>Please connect the <b id="modal-side"></b> side and double-tap the reset button.</p>
                <div class="spinner"></div>
                <p style="color: #6b7280; font-size: 0.9rem;">Searching for device...</p>
                <button class="btn" style="background:#ef4444; margin-top:1rem;"
                    onclick="closeFlashModal()">Cancel</button>
            </div>

            <div id="modal-step-2" class="hidden">
                <div style="font-size: 3rem; color: #059669; margin-bottom: 0.5rem;">✓</div>
                <h3 style="margin:0; color:#059669;">Device Found!</h3>
                <p style="margin: 0.5rem 0;">Ready to flash <b id="found-path"></b></p>
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn" style="background:#ef4444;" onclick="closeFlashModal()">Cancel</button>
                    <button id="flash-confirm-btn" class="btn btn-green">Flash Firmware</button>
                </div>
            </div>

            <div id="modal-step-3" class="hidden">
                <div class="spinner"></div>
                <p>Flashing firmware... Please wait.</p>
            </div>

            <div id="modal-step-4" class="hidden">
                <div style="font-size: 3rem; color: #059669; margin-bottom: 0.5rem;">✓</div>
                <h3 style="margin:0; color:#059669;">Flash Complete!</h3>
                <p>You can now unplug the device.</p>
                <button class="btn" style="margin-top:1rem;" onclick="closeFlashModal()">Close</button>
            </div>
            <div id="modal-step-error" class="hidden">
                <h3 style="margin:0; color:#dc2626;">Error</h3>
                <p id="flash-error-msg" style="color:#ef4444"></p>
                <button class="btn" style="margin-top:1rem;" onclick="closeFlashModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let pollInterval; // for build log
        let mountPollInterval;
        let currentSide = null;

        function openFlashModal(side) {
            currentSide = side;
            document.getElementById('flash-modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = `Flash ${side.toUpperCase()} Side`;
            document.getElementById('modal-side').innerText = side.toUpperCase();

            // Reset steps
            document.getElementById('modal-step-1').classList.remove('hidden');
            document.getElementById('modal-step-2').classList.add('hidden');
            document.getElementById('modal-step-3').classList.add('hidden');
            document.getElementById('modal-step-4').classList.add('hidden');
            document.getElementById('modal-step-error').classList.add('hidden');

            // Start polling
            if (mountPollInterval) clearInterval(mountPollInterval);
            mountPollInterval = setInterval(checkMount, 5000);
            checkMount(); // immediate
        }

        function closeFlashModal() {
            document.getElementById('flash-modal').classList.add('hidden');
            if (mountPollInterval) clearInterval(mountPollInterval);
            currentSide = null;
        }

        async function checkMount() {
            try {
                const res = await fetch('/check_mount');
                const data = await res.json();

                if (data.mounted) {
                    clearInterval(mountPollInterval);
                    document.getElementById('found-path').innerText = data.path;
                    document.getElementById('modal-step-1').classList.add('hidden');
                    document.getElementById('modal-step-2').classList.remove('hidden');

                    document.getElementById('flash-confirm-btn').onclick = () => performFlash();
                }
            } catch (e) {
                console.error("Mount check error", e);
            }
        }

        async function performFlash() {
            document.getElementById('modal-step-2').classList.add('hidden');
            document.getElementById('modal-step-3').classList.remove('hidden');

            try {
                const res = await fetch(`/flash/${currentSide}`, { method: 'POST' });
                const data = await res.json();

                document.getElementById('modal-step-3').classList.add('hidden');

                if (data.status === 'success') {
                    document.getElementById('modal-step-4').classList.remove('hidden');
                } else {
                    document.getElementById('flash-error-msg').innerText = data.message;
                    document.getElementById('modal-step-error').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('modal-step-3').classList.add('hidden');
                document.getElementById('flash-error-msg').innerText = "Network Error: " + e;
                document.getElementById('modal-step-error').classList.remove('hidden');
            }
        }

</html >