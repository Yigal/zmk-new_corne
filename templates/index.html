<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZMK Configurator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            background: #f4f4f5;
            color: #18181b;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        h1 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #27272a;
        }

        h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e4e4e7;
            padding-bottom: 0.5rem;
        }

        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            background: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-green {
            background: #059669;
        }

        .btn-green:hover {
            background: #047857;
        }

        .btn-purple {
            background: #7c3aed;
        }

        .btn-purple:hover {
            background: #6d28d9;
        }

        .flash-messages {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            background: #dbeafe;
            color: #1e40af;
        }

        .row {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .hidden {
            display: none !important;
        }

        #build-log-container {
            background: #1e1e1e;
            color: #e5e5e5;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
            white-space: pre-wrap;
            font-size: 0.85rem;
        }

        #timer {
            float: right;
            font-weight: bold;
            color: #7c3aed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>ZMK Corne Configurator
            <button class="btn" onclick="openHelpModal()" style="float: right; font-size: 0.8rem;">ðŸ“– Help &
                Guide</button>
        </h1>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="flash-messages">
            {% for message in messages %}<div>{{ message }}</div>{% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <h2>1. Import Layout</h2>
        <p>Choose an existing template or upload a new <code>.vil</code> file.</p>
        <form action="/upload" method="post" enctype="multipart/form-data">
            <div style="margin-bottom: 1rem;">
                <label>Select Existing Template:</label>
                <select name="existing_file" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                    <option value="">-- Choose a file --</option>
                    {% for t in templates %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
                </select>
            </div>
            <div style="text-align: center; margin: 1rem 0; font-weight: bold; color: #71717a;">- OR -</div>
            <div style="margin-bottom: 1rem;">
                <label>Upload New:</label>
                <input type="file" name="vil_file" accept=".vil" style="display: block; margin-top: 0.5rem;">
            </div>
            <button type="submit" class="btn">Convert to Keymap</button>
        </form>

        {% if conversion_stats %}
        <div
            style="margin-top: 1.5rem; background: #fafafa; border: 1px solid #e4e4e7; border-radius: 8px; padding: 1rem;">
            <h3 style="margin-top: 0; font-size: 1.1rem; color: #27272a;">Conversion Report</h3>
            <pre style="margin: 0; color: #52525b; font-size: 0.9rem;">{{ conversion_stats }}</pre>
            {% if layer_images %}
            <div style="margin-top: 1rem;">
                <h4 style="margin: 0.5rem 0; color: #3f3f46;">Generated Layout Previews</h4>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for img in layer_images %}
                    <div style="border: 1px solid #ddd; padding: 0.5rem; background: white; border-radius: 6px;">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ img.replace('.png', '').replace('_',
                            ' ').upper() }}</div>
                        <img src="{{ url_for('static', filename='images/' + img) }}"
                            style="max-width: 100%; height: auto; display: block;" alt="{{ img }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if keymap_content %}
            <details style="margin-top: 1rem;">
                <summary style="cursor: pointer; color: #2563eb; font-weight: 500;">View Generated Keymap File</summary>
                <pre
                    style="height: 300px; overflow: auto; margin-top: 0.5rem; background: #1e1e1e; color: #e5e5e5; padding: 1rem; border-radius: 6px; font-size: 0.85rem;">{{ keymap_content }}</pre>
            </details>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="card">
        <h2>2. Build Firmware <span id="timer" class="hidden">00:00</span></h2>
        <p>Push changes to GitHub to trigger a cloud build. This takes ~3 minutes.</p>
        <button id="build-btn" class="btn btn-purple" onclick="triggerBuild()">Push & Trigger Build</button>
        <div id="build-log-container" class="hidden">Waiting for logs...</div>
    </div>

    <div class="card">
        <h2>3. Flash Firmware</h2>
        <p>Select a build and flash to your keyboard.</p>
        <div style="margin-bottom: 1rem;">
            <label>Select Build:</label>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                <select id="build-select" style="flex: 1; padding: 0.5rem;">
                    <option value="firmware_latest">Latest Build (firmware_latest)</option>
                    {% for build in builds %}
                    <option value="{{ build.name }}">Build #{{ build.run_number }} - {{ build.title[:30] }} ({{
                        build.name }})</option>
                    {% endfor %}
                </select>
                <button class="btn" onclick="refreshBuilds()" style="padding: 0.5rem 1rem;">ðŸ”„</button>
            </div>
        </div>
        <div class="row">
            <button class="btn btn-green" onclick="openFlashModal('left')">Flash Left Side</button>
            <button class="btn btn-green" onclick="openFlashModal('right')">Flash Right Side</button>
        </div>
    </div>

    <!-- Flash Modal -->
    <div id="flash-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2 id="modal-title" style="margin-top:0">Flash Device</h2>
            <div id="modal-step-1">
                <p>Please connect the <b id="modal-side"></b> side and double-tap the reset button.</p>
                <div class="spinner"></div>
                <p style="color: #6b7280; font-size: 0.9rem;">Searching for device...</p>
                <button class="btn" style="background:#ef4444; margin-top:1rem;"
                    onclick="closeFlashModal()">Cancel</button>
            </div>
            <div id="modal-step-2" class="hidden">
                <div style="font-size: 3rem; color: #059669; margin-bottom: 0.5rem;">âœ“</div>
                <h3 style="margin:0; color:#059669;">Device Found!</h3>
                <p style="margin: 0.5rem 0;">Ready to flash <b id="found-path"></b></p>
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn" style="background:#ef4444;" onclick="closeFlashModal()">Cancel</button>
                    <button id="flash-confirm-btn" class="btn btn-green">Flash Firmware</button>
                </div>
            </div>
            <div id="modal-step-3" class="hidden">
                <div class="spinner"></div>
                <p>Flashing firmware... Please wait.</p>
            </div>
            <div id="modal-step-4" class="hidden">
                <div style="font-size: 3rem; color: #059669; margin-bottom: 0.5rem;">âœ“</div>
                <h3 style="margin:0; color:#059669;">Flash Complete!</h3>
                <p>You can now unplug the device.</p>
                <button class="btn" style="margin-top:1rem;" onclick="closeFlashModal()">Close</button>
            </div>
            <div id="modal-step-error" class="hidden">
                <h3 style="margin:0; color:#dc2626;">Error</h3>
                <p id="flash-error-msg" style="color:#ef4444"></p>
                <button class="btn" style="margin-top:1rem;" onclick="closeFlashModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let pollInterval;
        let mountPollInterval;
        let currentSide = null;

        // Build Functions
        async function triggerBuild() {
            const btn = document.getElementById('build-btn');
            const logBox = document.getElementById('build-log-container');
            btn.disabled = true;
            btn.innerText = "Starting...";
            logBox.classList.remove('hidden');
            logBox.innerText = "Initiating build process...\n";
            try {
                const res = await fetch('/git_push', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    startPolling();
                } else {
                    logBox.innerText += "\nError: " + data.message;
                    btn.disabled = false;
                }
            } catch (e) {
                logBox.innerText += "\nNetwork Error: " + e;
                btn.disabled = false;
            }
        }

        function startPolling() {
            document.getElementById('timer').classList.remove('hidden');
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(fetchLogs, 2000);
            fetchLogs();
        }

        async function fetchLogs() {
            try {
                const res = await fetch('/build_status');
                const data = await res.json();
                const logBox = document.getElementById('build-log-container');
                if (data.logs) logBox.innerText = data.logs;
                logBox.scrollTop = logBox.scrollHeight;
                if (data.duration > 0) {
                    const mins = Math.floor(data.duration / 60);
                    const secs = data.duration % 60;
                    document.getElementById('timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                }
                if (data.logs && data.logs.includes("Build Complete")) {
                    clearInterval(pollInterval);
                    document.getElementById('timer').innerText += " (Done!)";
                    document.getElementById('build-btn').innerText = "Push & Trigger Build";
                    document.getElementById('build-btn').disabled = false;
                    refreshBuilds(); // Auto-refresh builds list when done
                }
            } catch (e) {
                console.error("Poll error", e);
            }
        }

        // Refresh Builds List
        async function refreshBuilds() {
            try {
                const res = await fetch('/list_builds');
                const data = await res.json();
                const select = document.getElementById('build-select');
                const currentValue = select.value;
                select.innerHTML = '<option value="firmware_latest">Latest Build (firmware_latest)</option>';
                data.builds.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.name;
                    opt.textContent = `Build #${b.run_number} - ${b.title.substring(0, 30)} (${b.name})`;
                    select.appendChild(opt);
                });
                // Try to restore previous selection
                if ([...select.options].some(o => o.value === currentValue)) {
                    select.value = currentValue;
                }
            } catch (e) {
                console.error("Refresh builds error", e);
            }
        }

        // Flash Modal Functions
        function openFlashModal(side) {
            currentSide = side;
            document.getElementById('flash-modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = `Flash ${side.toUpperCase()} Side`;
            document.getElementById('modal-side').innerText = side.toUpperCase();
            document.getElementById('modal-step-1').classList.remove('hidden');
            document.getElementById('modal-step-2').classList.add('hidden');
            document.getElementById('modal-step-3').classList.add('hidden');
            document.getElementById('modal-step-4').classList.add('hidden');
            document.getElementById('modal-step-error').classList.add('hidden');
            if (mountPollInterval) clearInterval(mountPollInterval);
            mountPollInterval = setInterval(checkMount, 5000);
            checkMount();
        }

        function closeFlashModal() {
            document.getElementById('flash-modal').classList.add('hidden');
            if (mountPollInterval) clearInterval(mountPollInterval);
            currentSide = null;
        }

        async function checkMount() {
            try {
                const res = await fetch('/check_mount');
                const data = await res.json();
                if (data.mounted) {
                    clearInterval(mountPollInterval);
                    document.getElementById('found-path').innerText = data.path;
                    document.getElementById('modal-step-1').classList.add('hidden');
                    document.getElementById('modal-step-2').classList.remove('hidden');
                    document.getElementById('flash-confirm-btn').onclick = () => performFlash();
                }
            } catch (e) {
                console.error("Mount check error", e);
            }
        }

        async function performFlash() {
            document.getElementById('modal-step-2').classList.add('hidden');
            document.getElementById('modal-step-3').classList.remove('hidden');
            const selectedBuild = document.getElementById('build-select').value;
            try {
                const res = await fetch(`/flash/${currentSide}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ build: selectedBuild })
                });
                const data = await res.json();
                document.getElementById('modal-step-3').classList.add('hidden');
                if (data.status === 'success') {
                    document.getElementById('modal-step-4').classList.remove('hidden');
                } else {
                    document.getElementById('flash-error-msg').innerText = data.message;
                    document.getElementById('modal-step-error').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('modal-step-3').classList.add('hidden');
                document.getElementById('flash-error-msg').innerText = "Network Error: " + e;
                document.getElementById('modal-step-error').classList.remove('hidden');
            }
        }

        // Help Modal Functions
        function openHelpModal() {
            document.getElementById('help-modal').classList.remove('hidden');
        }
        function closeHelpModal() {
            document.getElementById('help-modal').classList.add('hidden');
        }

        // Wizard Functions
        const totalSteps = 6;

        function verifyStep(stepNum) {
            const stepEl = document.getElementById(`wizard-step-${stepNum}`);
            const btnEl = stepEl.querySelector('.verify-btn');

            // Mark current step as completed
            stepEl.classList.add('completed');
            stepEl.style.opacity = '1';
            btnEl.innerHTML = 'âœ“ Verified';
            btnEl.disabled = true;
            btnEl.style.background = '#9ca3af';

            // Enable next step
            if (stepNum < totalSteps) {
                const nextStep = document.getElementById(`wizard-step-${stepNum + 1}`);
                nextStep.style.opacity = '1';
                nextStep.querySelector('.verify-btn').disabled = false;
            }

            // Check if all done
            if (stepNum === totalSteps) {
                document.getElementById('wizard-complete').classList.remove('hidden');
            }
        }

        function resetWizard() {
            for (let i = 1; i <= totalSteps; i++) {
                const stepEl = document.getElementById(`wizard-step-${i}`);
                const btnEl = stepEl.querySelector('.verify-btn');
                stepEl.classList.remove('completed');
                stepEl.style.opacity = i === 1 ? '1' : '0.5';
                btnEl.innerHTML = 'âœ“ Done';
                btnEl.disabled = i !== 1;
                btnEl.style.background = '';
            }
            document.getElementById('wizard-complete').classList.add('hidden');
        }
    </script>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden" onclick="if(event.target===this) closeHelpModal()">
        <div class="modal" style="width: 600px; text-align: left; max-height: 85vh; overflow-y: auto;">
            <h2 style="margin-top: 0; text-align: center;">ï¿½ Setup Wizard</h2>
            <p style="text-align: center; color: #6b7280; margin-bottom: 1.5rem;">Follow each step and verify before
                continuing</p>

            <!-- Step 1 -->
            <div class="wizard-step" id="wizard-step-1">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span class="step-number" id="step-num-1">1</span>
                    <h3 style="margin: 0; flex: 1;">Unplug Both Keyboard Halves</h3>
                    <button class="btn btn-green verify-btn" onclick="verifyStep(1)">âœ“ Done</button>
                </div>
                <p style="margin: 0 0 0 2.5rem; color: #6b7280;">Disconnect any USB cables from both sides of your
                    keyboard.</p>
            </div>

            <!-- Step 2 -->
            <div class="wizard-step" id="wizard-step-2" style="opacity: 0.5;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span class="step-number" id="step-num-2">2</span>
                    <h3 style="margin: 0; flex: 1;">Flash the LEFT Side First</h3>
                    <button class="btn btn-green verify-btn" onclick="verifyStep(2)" disabled>âœ“ Done</button>
                </div>
                <p style="margin: 0 0 0 2.5rem; color: #6b7280;">The left side is the <b>central/host</b>. Double-tap
                    reset, then use the Flash tool above.</p>
            </div>

            <!-- Step 3 -->
            <div class="wizard-step" id="wizard-step-3" style="opacity: 0.5;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span class="step-number" id="step-num-3">3</span>
                    <h3 style="margin: 0; flex: 1;">Flash the RIGHT Side</h3>
                    <button class="btn btn-green verify-btn" onclick="verifyStep(3)" disabled>âœ“ Done</button>
                </div>
                <p style="margin: 0 0 0 2.5rem; color: #6b7280;">The right side connects wirelessly to the left.
                    Double-tap reset and flash.</p>
            </div>

            <!-- Step 4 -->
            <div class="wizard-step" id="wizard-step-4" style="opacity: 0.5;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span class="step-number" id="step-num-4">4</span>
                    <h3 style="margin: 0; flex: 1;">Plug in ONLY the Left Side</h3>
                    <button class="btn btn-green verify-btn" onclick="verifyStep(4)" disabled>âœ“ Done</button>
                </div>
                <p style="margin: 0 0 0 2.5rem; color: #6b7280;">Connect just the left half via USB. The right half
                    should power on automatically (if it has a battery).</p>
            </div>

            <!-- Step 5 -->
            <div class="wizard-step" id="wizard-step-5" style="opacity: 0.5;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span class="step-number" id="step-num-5">5</span>
                    <h3 style="margin: 0; flex: 1;">Verify Halves Are Connected</h3>
                    <button class="btn btn-green verify-btn" onclick="verifyStep(5)" disabled>âœ“ Done</button>
                </div>
                <p style="margin: 0 0 0 2.5rem; color: #6b7280;">Try pressing keys on both sides. If OLED is present, it
                    should show "Connected".</p>
            </div>

            <!-- Step 6 -->
            <div class="wizard-step" id="wizard-step-6" style="opacity: 0.5;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span class="step-number" id="step-num-6">6</span>
                    <h3 style="margin: 0; flex: 1;">Pair via Bluetooth (Optional)</h3>
                    <button class="btn btn-green verify-btn" onclick="verifyStep(6)" disabled>âœ“ Done</button>
                </div>
                <p style="margin: 0 0 0 2.5rem; color: #6b7280;">Go to Bluetooth Settings on your device. Look for
                    "Corne" and click Pair. No PIN needed!</p>
            </div>

            <!-- Completion -->
            <div id="wizard-complete" class="hidden"
                style="text-align: center; padding: 1.5rem; background: #ecfdf5; border-radius: 8px; margin-top: 1rem;">
                <div style="font-size: 3rem;">ðŸŽ‰</div>
                <h3 style="color: #059669; margin: 0.5rem 0;">Setup Complete!</h3>
                <p style="color: #6b7280; margin: 0;">Your keyboard is ready to use. Enjoy!</p>
            </div>

            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <button class="btn" onclick="resetWizard()"
                    style="margin-right: 0.5rem; background: #6b7280;">Reset</button>
                <button class="btn" onclick="closeHelpModal()">Close</button>
            </div>
        </div>
    </div>

    <style>
        .wizard-step {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .wizard-step.completed {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #e5e7eb;
            color: #374151;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .wizard-step.completed .step-number {
            background: #059669;
            color: white;
        }

        .verify-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
        }

        .verify-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
    </style>
</body>

</html>